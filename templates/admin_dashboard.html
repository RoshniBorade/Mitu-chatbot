<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - MITU Skillologies</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='admin_style.css') }}">
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body>
    <!-- Sidebar -->
    <aside class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <h2>MITU Admin</h2>
            <button class="toggle-btn" id="toggleSidebar">
                <i class="fas fa-bars"></i>
            </button>
        </div>
        <ul class="nav-links">
            <li class="nav-item">
                <a href="{{ url_for('admin_dashboard') }}" class="nav-link active">
                    <i class="fas fa-th-large"></i>
                    <span>Dashboard</span>
                </a>
            </li>
            <li class="nav-item">
                <a href="#leadsSection" class="nav-link">
                    <i class="fas fa-user-graduate"></i>
                    <span>Leads</span>
                </a>
            </li>
            <li class="nav-item">
                <a href="#usersSection" class="nav-link">
                    <i class="fas fa-users"></i>
                    <span>Users</span>
                </a>
            </li>
            <li class="nav-item">
                <a href="#activitySection" class="nav-link">
                    <i class="fas fa-history"></i>
                    <span>Activity</span>
                </a>
            </li>
        </ul>
        <div class="logout-section">
            <a href="{{ url_for('logout') }}" class="nav-link" style="color: #ef4444;">
                <i class="fas fa-sign-out-alt"></i>
                <span>Logout</span>
            </a>
        </div>
    </aside>

    <!-- Main Content -->
    <main class="main-content">
        <header class="header-section">
            <div>
                <h1>Dashboard Overview</h1>
                <p style="color: var(--text-muted);">Welcome back, Admin! Here's what's happening today.</p>
            </div>
            <div class="header-actions">
                <button class="btn-primary" onclick="window.location.reload()"><i class="fas fa-sync-alt"></i> Refresh
                    Data</button>
            </div>
        </header>

        <!-- Stats Cards -->
        <div class="stats-grid">
            <div class="stat-card" style="animation-delay: 0.1s;">
                <div class="stat-icon" style="background: rgba(59, 130, 246, 0.1); color: #3b82f6;">
                    <i class="fas fa-users"></i>
                </div>
                <div class="stat-info">
                    <h3>{{ total_users }}</h3>
                    <p>Total Users</p>
                </div>
            </div>
            <div class="stat-card" style="animation-delay: 0.2s;">
                <div class="stat-icon" style="background: rgba(99, 102, 241, 0.1); color: #6366f1;">
                    <i class="fas fa-user-graduate"></i>
                </div>
                <div class="stat-info">
                    <h3>{{ total_leads }}</h3>
                    <p>Total Leads</p>
                </div>
            </div>
            <div class="stat-card" style="animation-delay: 0.3s;">
                <div class="stat-icon" style="background: rgba(16, 185, 129, 0.1); color: #10b981;">
                    <i class="fas fa-check-circle"></i>
                </div>
                <div class="stat-info">
                    <h3>{{ converted_leads }}</h3>
                    <p>Converted Leads</p>
                </div>
            </div>
            <div class="stat-card" style="animation-delay: 0.4s;">
                <div class="stat-icon" style="background: rgba(245, 158, 11, 0.1); color: #f59e0b;">
                    <i class="fas fa-chart-line"></i>
                </div>
                <div class="stat-info">
                    <h3>{{ conversion_rate }}%</h3>
                    <p>Conversion Rate</p>
                </div>
            </div>
        </div>

        <!-- Charts Section -->
        <div class="charts-grid">
            <div class="chart-card">
                <h3>Leads by Course</h3>
                <canvas id="leadsByCourseChart" height="150"></canvas>
            </div>
            <div class="chart-card">
                <h3>Leads by Status</h3>
                <canvas id="leadsByStatusChart" height="300"></canvas>
            </div>
        </div>

        <!-- Filters & Lead Management -->
        <section id="leadsSection">
            <div class="header-section">
                <h2>Lead Management</h2>
            </div>

            <div class="filter-container">
                <form method="GET" style="display: flex; gap: 15px; flex-wrap: wrap; width: 100%;">
                    <div class="search-bar">
                        <i class="fas fa-search"></i>
                        <input type="text" placeholder="Search leads..." id="leadSearch">
                    </div>
                    <div class="filter-group">
                        <select name="course">
                            <option value="">All Courses</option>
                            {% for c in all_courses %}
                            <option value="{{ c }}" {% if course_filter==c %}selected{% endif %}>{{ c }}</option>
                            {% endfor %}
                        </select>
                        <select name="status">
                            <option value="">All Statuses</option>
                            {% for s in all_statuses %}
                            <option value="{{ s }}" {% if status_filter==s %}selected{% endif %}>{{ s }}</option>
                            {% endfor %}
                        </select>
                        <button type="submit" class="btn-primary">Apply</button>
                        <a href="{{ url_for('admin_dashboard') }}" class="btn-primary"
                            style="background: #94a3b8; text-decoration: none; display: flex; align-items: center; justify-content: center;">Reset</a>
                    </div>
                </form>
            </div>

            <div class="data-card">
                <div class="table-responsive">
                    <table id="leadsTable">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Name</th>
                                <th>Contact</th>
                                <th>Course</th>
                                <th>Status</th>
                                <th>Date</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% if leads %}
                            {% for lead in leads %}
                            <tr>
                                <td style="font-weight: 600; color: var(--primary);">#{{ lead[0] }}</td>
                                <td>
                                    <div style="font-weight: 500;">{{ lead[1] }}</div>
                                </td>
                                <td>
                                    <div>{{ lead[2] }}</div>
                                    <small style="color: var(--text-muted);">{{ lead[3] }}</small>
                                </td>
                                <td><span style="font-size: 0.9rem;">{{ lead[4] }}</span></td>
                                <td>
                                    <span class="status-pill {{ lead[5]|lower }}">
                                        {{ lead[5] }}
                                    </span>
                                </td>
                                <td>{{ lead[6] }}</td>
                                <td>
                                    <div style="display: flex; gap: 8px;">
                                        {% if lead[5] != 'Contacted' and lead[5] != 'Converted' %}
                                        <a href="{{ url_for('update_lead_status', lead_id=lead[0], status='Contacted') }}"
                                            class="status-pill contacted" style="text-decoration: none;"><i
                                                class="fas fa-phone"></i></a>
                                        {% endif %}
                                        {% if lead[5] != 'Converted' %}
                                        <a href="{{ url_for('update_lead_status', lead_id=lead[0], status='Converted') }}"
                                            class="status-pill converted" style="text-decoration: none;"><i
                                                class="fas fa-check"></i></a>
                                        {% endif %}
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                            {% else %}
                            <tr>
                                <td colspan="7" style="text-align: center; padding: 40px; color: var(--text-muted);">
                                    <i class="fas fa-folder-open"
                                        style="font-size: 2rem; display: block; margin-bottom: 10px;"></i>
                                    No leads found matching your filters.
                                </td>
                            </tr>
                            {% endif %}
                        </tbody>
                    </table>
                </div>
            </div>
        </section>

        <!-- Secondary Grid: Users and Activity -->
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 25px;">
            <!-- Registered Users -->
            <section id="usersSection">
                <div class="data-card">
                    <div class="card-header">
                        <h3>Registered Users</h3>
                    </div>
                    <div class="table-responsive" style="max-height: 400px;">
                        <table>
                            <thead>
                                <tr>
                                    <th>User</th>
                                    <th>Role</th>
                                    <th>Verified</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for user in users %}
                                <tr>
                                    <td>
                                        <div style="font-weight: 500;">{{ user[1] }}</div>
                                        <small style="color: var(--text-muted);">{{ user[2] }}</small>
                                    </td>
                                    <td><span style="font-size: 0.85rem;">{{ user[3] }}</span></td>
                                    <td>
                                        {% if user[4] %}
                                        <i class="fas fa-check-circle" style="color: var(--success);"></i>
                                        {% else %}
                                        <i class="fas fa-times-circle" style="color: var(--danger);"></i>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if not user[4] %}
                                        <a href="{{ url_for('admin_verify_user', user_id=user[0]) }}"
                                            class="status-pill contacted"
                                            style="text-decoration: none; font-size: 0.7rem;">Verify</a>
                                        {% else %}
                                        <span style="color: #cbd5e1;">-</span>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- Recent Activity Timeline -->
            <section id="activitySection">
                <div class="data-card">
                    <div class="card-header">
                        <h3>Recent Activity</h3>
                    </div>
                    <div class="activity-list">
                        {% for log in logs[:10] %}
                        <div class="activity-item">
                            <div class="activity-dot"
                                style="background: {% if log[4] == 'Success' %}var(--success){% else %}var(--danger){% endif %};">
                            </div>
                            <div class="activity-content">
                                <h4>{{ log[1] }} - {{ log[4] }} Login</h4>
                                <p>{{ log[0] }} from {{ log[3] }}</p>
                            </div>
                        </div>
                        {% endfor %}

                        <!-- Extra entries for visual style if logs are sparse -->
                        {% if leads %}
                        <div class="activity-item">
                            <div class="activity-dot" style="background: var(--primary);"></div>
                            <div class="activity-content">
                                <h4>New Lead: {{ leads[0][1] }}</h4>
                                <p>Interested in {{ leads[0][4] }} - {{ leads[0][6] }}</p>
                            </div>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </section>
        </div>
    </main>

    <!-- Scripts -->
    <script>
        // Sidebar Toggle
        const sidebar = document.getElementById('sidebar');
        const toggleBtn = document.getElementById('toggleSidebar');

        toggleBtn.addEventListener('click', () => {
            sidebar.classList.toggle('collapsed');
        });

        // Mobile responsiveness
        if (window.innerWidth < 768) {
            sidebar.classList.add('collapsed');
        }

        // Search Functionality (Frontend Only for UI feel)
        document.getElementById('leadSearch').addEventListener('keyup', function () {
            let filter = this.value.toLowerCase();
            let rows = document.querySelectorAll('#leadsTable tbody tr');

            rows.forEach(row => {
                let name = row.cells[1].textContent.toLowerCase();
                let email = row.cells[2].textContent.toLowerCase();
                if (name.includes(filter) || email.includes(filter)) {
                    row.style.display = "";
                } else {
                    row.style.display = "none";
                }
            });
        });

        // Charts Initialization
        console.log("Initializing charts...");
        const courseLabels = {{ leads_by_course | map(attribute = 0) | list | tojson }};
        const courseData = {{ leads_by_course | map(attribute = 1) | list | tojson }};

        const statusLabels = {{ leads_by_status | map(attribute = 0) | list | tojson }};
        const statusData = {{ leads_by_status | map(attribute = 1) | list | tojson }};

        console.log("Course Data:", courseLabels, courseData);
        console.log("Status Data:", statusLabels, statusData);

        // Bar Chart - Leads by Course
        new Chart(document.getElementById('leadsByCourseChart'), {
            type: 'bar',
            data: {
                labels: courseLabels,
                datasets: [{
                    label: 'Leads per Course',
                    data: courseData,
                    backgroundColor: '#3b82f6',
                    borderRadius: 8
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: { display: false }
                },
                scales: {
                    y: { beginAtZero: true, grid: { display: false } },
                    x: { grid: { display: false } }
                }
            }
        });

        // Doughnut Chart - Leads by Status
        new Chart(document.getElementById('leadsByStatusChart'), {
            type: 'doughnut',
            data: {
                labels: statusLabels,
                datasets: [{
                    data: statusData,
                    backgroundColor: ['#f59e0b', '#3b82f6', '#10b981', '#ef4444'],
                    borderWidth: 0
                }]
            },
            options: {
                responsive: true,
                cutout: '70%',
                plugins: {
                    legend: { position: 'bottom' }
                }
            }
        });
    </script>
</body>

</html>